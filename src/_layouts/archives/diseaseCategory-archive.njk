---
# This front matter tells Eleventy to create a page for each unique disease category
pagination:
  data: collections.uniqueDiseaseCategories # Use the custom collection from .eleventy.js
  size: 1                                 # Create one page per category
  alias: currentCategoryName              # This is how we'll refer to the current category
  addAllPagesToCollections: true          # Optional: adds these pages to collections.all
# This permalink creates URLs like /trials/categories/sepsis/, /trials/categories/ich/, etc.
permalink: /trials/categories/{{ currentCategoryName | slugify }}/index.html # Ensure 'slugify' matches your filter name
layout: layouts/page.njk                  # Use your general page layout, or create a specific one for archives
eleventyComputed:
  title: "Trials for {{ currentCategoryName }}" # Dynamic page title
---

{# Filter trials to get only those that include the currentCategoryName #}
{% set trialsForThisCategory = [] %}
{% for trial in collections.allTrials %} {# Use collections.allTrials which you defined #}
  {% if trial.data.diseaseCategories and currentCategoryName in trial.data.diseaseCategories %}
    {# If the trial's diseaseCategories array contains the currentCategoryName, add it to our list #}
    {% set trialsForThisCategory = (trialsForThisCategory.push(trial), trialsForThisCategory) %}
  {% endif %}
{% endfor %}

<div class="region">
  <div class="wrapper flow prose">
    {# Display the dynamic title generated by eleventyComputed #}
    <h1>{{ title }}</h1>
    <p>Displaying critical care trial summaries categorized under: <strong>{{ currentCategoryName }}</strong>.</p>

    {% if trialsForThisCategory.length > 0 %}
      <ul class="trials-list flow" style="--flow-space: var(--space-l);">
        {# Loop through the filtered trials for this category. #}
        {# collections.allTrials is already reversed in your collections.js, so no need for | reverse here unless you want to double-reverse #}
        {% for trial in trialsForThisCategory %}
          <li class="trial-item" style="margin-bottom: var(--space-l);">
            <h2>
              <a href="{{ trial.url | url }}">
                {{ trial.data.acronym or trial.data.title }} {# Show acronym if available, else title #}
              </a>
            </h2>
            {% if trial.data.datePublished %}
              <p class="meta-info" style="margin-bottom: var(--space-2xs);">
                <strong>Trial Published:</strong>
                {% set definedDate = trial.data.datePublished %}
                {% include "partials/date.njk" %}
              </p>
            {% endif %}

            {# Optionally, display topics related to this trial #}
            {% if trial.data.topics and trial.data.topics.length > 0 %}
              <p class="meta-info cluster gutter-xs-s" style="margin-bottom: var(--space-2xs);">
                <strong>Topics:</strong>
                {% for topicItem in trial.data.topics %}
                  <a href="/trials/topics/{{ topicItem | slugify }}/" class="button topic-tag" data-small-button> {# Ensure 'slugify' #}
                    {{ topicItem }}
                  </a>
                {% endfor %}
              </p>
            {% endif %}
            {# You could add a short excerpt/gist here if you define one in trial front matter #}
            {# e.g., <p>{{ trial.data.gist | truncate(150) }}</p> #}
            {# Ensure you have a 'truncate' filter if you use it, or remove this part #}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No trials found specifically for the category "{{ currentCategoryName }}".</p>
    {% endif %}

    {# Optional: Add a link back to the main trials listing or other relevant pages #}
    <p><a href="/trials/">View all trials</a></p> {# Assuming you'll have a /trials/ page #}
  </div>
</div>
